#!/bin/sh
set -e

# Map platform names
case "$(uname -s)" in
    Darwin) platform="darwin" ;;
    Linux) platform="linux" ;;
    MINGW*|CYGWIN*|MSYS*) platform="win32" ;;
    *) platform="$(uname -s | tr '[:upper:]' '[:lower:]')" ;;
esac

# Map architecture names  
case "$(uname -m)" in
    x86_64|amd64) arch="x64" ;;
    aarch64) arch="arm64" ;;
    *) arch="$(uname -m)" ;;
esac

name="shadcnify-${platform}-${arch}"
binary="shadcnify"
[ "$platform" = "win32" ] && binary="shadcnify.exe"

# Get script directory
script_path="$0"
while [ -L "$script_path" ]; do
    link_target="$(readlink "$script_path")"
    case "$link_target" in
        /*) script_path="$link_target" ;;
        *) script_path="$(dirname "$script_path")/$link_target" ;;
    esac
done
script_dir="$(cd "$(dirname "$script_path")" && pwd)"

# Search for the binary starting from script location
resolved=""
current_dir="$script_dir"
while [ "$current_dir" != "/" ]; do
    candidate="$current_dir/node_modules/$name/bin/$binary"
    if [ -f "$candidate" ]; then
        resolved="$candidate"
        break
    fi
    current_dir="$(dirname "$current_dir")"
done

if [ -z "$resolved" ]; then
    printf "Error: Could not find %s binary.\n" "$name" >&2
    printf "Your package manager may have failed to install the correct platform binary.\n" >&2
    printf "Try reinstalling: npm install -g shadcnify\n" >&2
    exit 1
fi

# Execute the binary with all arguments
exec "$resolved" "$@"
